import Head from 'next/head';
import { ReactNode, createContext, useMemo } from 'react';
import Header from './Header';
import { useWhoAmIQuery } from '../types/graphql';

export const UserContext = createContext({
  isLoggedIn: false,
  refetchLogin: () => {},
  role: 'user',
});

function Layout({ children }: { children: ReactNode }) {
  const {
    data, loading, error, refetch,
  } = useWhoAmIQuery();

  const userContextValue = useMemo(() => {
    if (data) {
      return {
        isLoggedIn: data.whoAmI.isLoggedIn,
        refetchLogin: refetch,
        role: data.whoAmI.role ?? 'user',
      };
    }
    return {
      isLoggedIn: false,
      refetchLogin: () => {},
      role: 'user',
    };
  }, [data, refetch]);

  if (loading) {
    return <p>Loading</p>;
  }
  if (error) {
    return <p>Error</p>;
  }

  return (

    <UserContext.Provider
      value={userContextValue}
    >
      <Head>
        <title>The Good Corner</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header />
      <main className="main-content">{children}</main>
    </UserContext.Provider>
  );
}

export default Layout;
